# ocr_gpt.py
import base64
import os
import json
import re
from typing import List, Dict

from dotenv import load_dotenv
from openai import OpenAI

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

_OPENAI_CLIENT = None

def _get_openai_client() -> OpenAI:
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI.
    –ù–µ –ø–∞–¥–∞–µ–º –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è, –∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API.
    """
    global _OPENAI_CLIENT
    if _OPENAI_CLIENT is not None:
        return _OPENAI_CLIENT
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        raise RuntimeError("–í .env –Ω–µ –Ω–∞–π–¥–µ–Ω OPENAI_API_KEY")
    _OPENAI_CLIENT = OpenAI(api_key=api_key)
    return _OPENAI_CLIENT


def _log_ocr_result(image_path: str, gpt_response: str):
    """–õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç OCR –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏."""
    from datetime import datetime
    from pathlib import Path
    
    log_dir = Path("logs")
    log_dir.mkdir(exist_ok=True)
    log_file = log_dir / "ocr_tables.log"
    
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    img_name = Path(image_path).name
    
    with open(log_file, "a", encoding="utf-8") as f:
        f.write("=" * 80 + "\n")
        f.write(f"Timestamp: {timestamp}\n")
        f.write(f"Image: {img_name}\n")
        f.write(f"GPT Response:\n{gpt_response}\n")
        f.write("=" * 80 + "\n\n")


def transcribe_audio(file_path: str) -> str:
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∞—É–¥–∏–æ-—Ñ–∞–π–ª (–≥–æ–ª–æ—Å–æ–≤–æ–µ) –≤ —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ Whisper."""
    client = _get_openai_client()
    with open(file_path, "rb") as f:
        result = client.audio.transcriptions.create(
            model="whisper-1",
            file=f,
            language="ru",
        )

    text = getattr(result, "text", None)
    if isinstance(result, dict):
        text = text or result.get("text")

    if not text:
        raise RuntimeError("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.")

    return text.strip()


def encode_image(image_path: str) -> str:
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ base64 –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ GPT."""
    with open(image_path, "rb") as f:
        return base64.b64encode(f.read()).decode("utf-8")


def _parse_json_strict_or_relaxed(text: str):
    """
    –ü—ã—Ç–∞–µ–º—Å—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –≤—ã—Ç–∞—â–∏—Ç—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT.
    –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∫–∞–∫ –µ—Å—Ç—å, –ø–æ—Ç–æ–º –∏—â–µ–º { ... } –∏–ª–∏ [ ... ].
    """
    text = (text or "").strip()

    # –£–±–∏—Ä–∞–µ–º markdown code blocks –µ—Å–ª–∏ –µ—Å—Ç—å
    text = re.sub(r'^```json\s*', '', text, flags=re.IGNORECASE)
    text = re.sub(r'^```\s*', '', text)
    text = re.sub(r'\s*```$', '', text)
    text = text.strip()

    # –ü—Ä–æ–±—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
    try:
        return json.loads(text)
    except json.JSONDecodeError as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        import sys
        print(f"[DEBUG] JSON parse error at position {e.pos}: {e.msg}", file=sys.stderr)
        print(f"[DEBUG] Text around error: ...{text[max(0, e.pos-50):e.pos+50]}...", file=sys.stderr)
    except Exception:
        pass

    # –ò—â–µ–º JSON-–æ–±—ä–µ–∫—Ç (–∂–∞–¥–Ω–æ, –±–µ—Ä—ë–º —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π)
    m = re.search(r"\{.*\}", text, re.S)
    if m:
        try:
            json_str = m.group(0)
            # –ü—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
            # –£–±–∏—Ä–∞–µ–º trailing commas –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º–∏ —Å–∫–æ–±–∫–∞–º–∏
            json_str = re.sub(r',(\s*[}\]])', r'\1', json_str)
            return json.loads(json_str)
        except json.JSONDecodeError as e:
            # –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è, –ø—Ä–æ–±—É–µ–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –Ω–∞–π—Ç–∏ –≤–∞–ª–∏–¥–Ω—ã–π JSON
            pass
    
    # –ò—â–µ–º –º–∞—Å—Å–∏–≤
    m = re.search(r"\[.*\]", text, re.S)
    if m:
        try:
            json_str = m.group(0)
            json_str = re.sub(r',(\s*\])', r'\1', json_str)
            return json.loads(json_str)
        except json.JSONDecodeError:
            pass
    
    # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: –∏—â–µ–º JSON –º–µ–∂–¥—É –ø–µ—Ä–≤–æ–π { –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π }
    first_brace = text.find('{')
    last_brace = text.rfind('}')
    if first_brace != -1 and last_brace != -1 and last_brace > first_brace:
        try:
            json_str = text[first_brace:last_brace+1]
            json_str = re.sub(r',(\s*[}\]])', r'\1', json_str)
            return json.loads(json_str)
        except json.JSONDecodeError:
            pass
    
    # –ù–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ
    raise RuntimeError(f"GPT –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON. –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤:\n{text[:500]}")


def _should_rotate_image(image_path: str) -> bool:
    """
    –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç GPT-4o, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–≤–µ—Ä–Ω—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ 90¬∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–≤–æ—Ä–æ—Ç, False –µ—Å–ª–∏ –Ω–µ—Ç.
    """
    try:
        b64 = encode_image(image_path)
        
        prompt = """–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –µ—ë –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é.

–í–û–ü–†–û–°: –ù—É–∂–Ω–æ –ª–∏ –ø–æ–≤–µ—Ä–Ω—É—Ç—å —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ 90¬∞ –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ)?

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–µ–π—á–∞—Å –∏–¥—ë—Ç –í–ï–†–¢–ò–ö–ê–õ–¨–ù–û (—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö –∏–ª–∏ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑) ‚Üí rotate: true
- –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –£–ñ–ï —á–∏—Ç–∞–µ—Ç—Å—è –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û (—Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ) ‚Üí rotate: false

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON:
{"rotate": true}  –∏–ª–∏  {"rotate": false}

–ë–ï–ó –æ–±—ä—è—Å–Ω–µ–Ω–∏–π! –¢–û–õ–¨–ö–û JSON!"""

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {"url": f"data:image/jpeg;base64,{b64}"}
                        }
                    ]
                }
            ],
            max_tokens=50,
            temperature=0
        )
        
        text = response.choices[0].message.content or ""
        result = _parse_json_strict_or_relaxed(text)
        
        import sys
        print(f"[INFO] GPT –æ–ø—Ä–µ–¥–µ–ª–∏–ª –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é: {result}", file=sys.stderr)
        
        return result.get("rotate", False)
        
    except Exception as e:
        import sys
        print(f"[WARN] –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ GPT: {e}, –æ—Å—Ç–∞–≤–ª—è—é –∫–∞–∫ –µ—Å—Ç—å", file=sys.stderr)
        return False


def _process_multiple_columns(column_images: list) -> Dict:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
    –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–ª–∏ –≤ —Å–æ—Å–µ–¥–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–∑-–∑–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è.
    """
    import sys
    
    all_items = []
    doc_type = "production"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    for idx, col_path in enumerate(column_images):
        print(f"[INFO] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∫–æ–ª–æ–Ω–∫—É {idx+1}/{len(column_images)}", file=sys.stderr)
        
        try:
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É —Å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–º –ø—Ä–æ–º–ø—Ç–æ–º
            result = _process_single_column(col_path, idx+1, len(column_images))
            
            # –ë–µ—Ä—ë–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
            if idx == 0:
                doc_type = result.get("doc_type", "production")
            
            # –î–æ–±–∞–≤–ª—è–µ–º items
            items = result.get("items", [])
            all_items.extend(items)
            
            print(f"[INFO] –ö–æ–ª–æ–Ω–∫–∞ {idx+1}: –Ω–∞–π–¥–µ–Ω–æ {len(items)} –ø–æ–∑–∏—Ü–∏–π", file=sys.stderr)
            
        except Exception as e:
            print(f"[WARN] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–ª–æ–Ω–∫–∏ {idx+1}: {e}", file=sys.stderr)
            continue
    
    # –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: —É–¥–∞–ª—è–µ–º –ø–æ–ª–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã (–æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ò –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
    # –≠—Ç–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –∫–æ–ª–æ–Ω–æ–∫
    seen = set()
    unique_items = []
    duplicates_removed = 0
    
    for item in all_items:
        key = (item.get("name", "").lower().strip(), item.get("qty", 0))
        if key not in seen:
            seen.add(key)
            unique_items.append(item)
        else:
            duplicates_removed += 1
            print(f"[DEBUG] –£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç –∏–∑ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è: {item.get('name')} ({item.get('qty')})", file=sys.stderr)
    
    if duplicates_removed > 0:
        print(f"[INFO] –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: —É–¥–∞–ª–µ–Ω–æ {duplicates_removed} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏–∑ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–π –∫–æ–ª–æ–Ω–æ–∫", file=sys.stderr)
    
    return {
        "doc_type": doc_type,
        "items": unique_items
    }


def _process_single_column(image_path: str, col_num: int, total_cols: int) -> Dict:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É —Ç–∞–±–ª–∏—Ü—ã."""
    b64 = encode_image(image_path)
    
    prompt = f"""
–¢—ã —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—à—å –û–î–ù–£ –∫–æ–ª–æ–Ω–∫—É —Ç–∞–±–ª–∏—Ü—ã (–∫–æ–ª–æ–Ω–∫–∞ {col_num} –∏–∑ {total_cols}).

–í–ê–ñ–ù–û: –≠—Ç–æ —Ç–æ–ª—å–∫–æ –û–î–ù–ê –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞! –ù–ï —á–∏—Ç–∞–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ!

–ó–ê–î–ê–ß–ê:
1. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É:
   - "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" = "production"
   - "–°–ø–∏—Å–∞–Ω–∏–µ" = "writeoff"
   - "–ü—Ä–∏—Ö–æ–¥" = "income"

2. –ü—Ä–æ—á–∏—Ç–∞–π —Ç–∞–±–ª–∏—Ü—É –°–¢–†–û–ì–û –°–í–ï–†–•–£ –í–ù–ò–ó:
   - –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞: [–ù–∞–∑–≤–∞–Ω–∏–µ] [–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ]
   - –ü—Ä–æ–ø—É—Å–∫–∞–π –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
   - –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = –ø—Ä–æ—á–µ—Ä–∫/–ø—É—Å—Ç–æ ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏

–í–ï–†–ù–ò JSON:
{{
  "doc_type": "production",
  "items": [
    {{"name": "–ù–∞–∑–≤–∞–Ω–∏–µ", "qty": 5.5}}
  ]
}}

–ë–ï–ó trailing commas! –ë–ï–ó markdown! –¢–û–õ–¨–ö–û JSON!
"""
    
    client = _get_openai_client()
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{b64}"
                        },
                    },
                ],
            }
        ],
        max_tokens=500,
        temperature=0,
    )
    
    text = response.choices[0].message.content or ""
    raw = _parse_json_strict_or_relaxed(text)
    
    if not isinstance(raw, dict):
        return {"doc_type": "production", "items": []}
    
    return raw


def _split_table_into_columns(image_path: str) -> list:
    """
    –£–º–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–≤–æ—Ä–æ—Ç–æ–º.
    
    –õ–æ–≥–∏–∫–∞:
    1. –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è (height > width √ó 1.3) - –ø—Ä–æ–±—É–µ–º –ø–æ–≤–µ—Ä–Ω—É—Ç—å
    2. –ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø–æ–≤–æ—Ä–æ—Ç–∞ —Å—Ç–∞–ª–∞ —à–∏—Ä–æ–∫–æ–π (width > height √ó 1.5) - –ø—Ä–∏–Ω–∏–º–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç
    3. –ï—Å–ª–∏ —à–∏—Ä–æ–∫–∞—è - —Ä–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ 2-4 –∫–æ–ª–æ–Ω–∫–∏
    4. –ò–Ω–∞—á–µ - –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –∫–æ–ª–æ–Ω–æ–∫.
    """
    try:
        from PIL import Image, ImageEnhance
        from pathlib import Path
        import sys
        
        img = Image.open(image_path)
        width, height = img.size
        
        print(f"[INFO] –ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {width}x{height} (—Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ {height/width:.2f}:1)", file=sys.stderr)
        
        # –£–ú–ù–´–ô –ü–û–í–û–†–û–¢ —á–µ—Ä–µ–∑ GPT: —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —É GPT, –Ω—É–∂–µ–Ω –ª–∏ –ø–æ–≤–æ—Ä–æ—Ç
        if _should_rotate_image(image_path):
            print(f"[INFO] GPT —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –ø–æ–≤–µ—Ä–Ω—É—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", file=sys.stderr)
            img = img.rotate(90, expand=True)
            width, height = img.size
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–≤–µ—Ä–Ω—É—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            rotated_path = str(Path(image_path).with_stem(Path(image_path).stem + "_rotated"))
            img.save(rotated_path, format='PNG', optimize=False)
            image_path = rotated_path
            print(f"[INFO] –ü–æ—Å–ª–µ –ø–æ–≤–æ—Ä–æ—Ç–∞: {width}x{height}", file=sys.stderr)
        else:
            print(f"[INFO] GPT –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é, –ø–æ–≤–æ—Ä–æ—Ç –Ω–µ –Ω—É–∂–µ–Ω", file=sys.stderr)
        
        # –ï—Å–ª–∏ —à–∏—Ä–∏–Ω–∞ –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç—ã –±–æ–ª–µ–µ —á–µ–º –≤ 1.5 —Ä–∞–∑–∞ - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–æ–∫
        if width > height * 1.5:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—é —Å—Ç–æ—Ä–æ–Ω
            ratio = width / height
            if ratio < 2.2:
                num_columns = 2
            elif ratio < 3.2:
                num_columns = 3
            else:
                num_columns = 4
            
            print(f"[INFO] –®–∏—Ä–æ–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ ({width}x{height}, —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ {ratio:.2f}:1), —Ä–∞–∑–¥–µ–ª—è—é –Ω–∞ {num_columns} –∫–æ–ª–æ–Ω–∫–∏", file=sys.stderr)
            
            column_width = width // num_columns
            column_images = []
            
            # –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            overlap = 80  # px –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏
            
            for i in range(num_columns):
                # –ë–∞–∑–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
                left = i * column_width
                right = (i + 1) * column_width if i < num_columns - 1 else width
                
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                # –î–ª—è –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ - —Ä–∞—Å—à–∏—Ä—è–µ–º –≤–ø—Ä–∞–≤–æ
                # –î–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π - —Ä–∞—Å—à–∏—Ä—è–µ–º –≤–ª–µ–≤–æ
                # –î–ª—è —Å—Ä–µ–¥–Ω–∏—Ö - –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã
                if i > 0:
                    left = max(0, left - overlap)
                if i < num_columns - 1:
                    right = min(width, right + overlap)
                
                print(f"[INFO] –ö–æ–ª–æ–Ω–∫–∞ {i+1}: –≥—Ä–∞–Ω–∏—Ü—ã [{left}:{right}] (—à–∏—Ä–∏–Ω–∞ {right-left}px)", file=sys.stderr)
                
                column = img.crop((left, 0, right, height))
                
                # –ö–†–ò–¢–ò–ß–ù–û: –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
                col_width, col_height = column.size
                # –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –º–µ–Ω—å—à–µ 2000px –ø–æ —à–∏—Ä–∏–Ω–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
                if col_width < 2000:
                    scale = 2000 / col_width
                    new_size = (int(col_width * scale), int(col_height * scale))
                    column = column.resize(new_size, Image.Resampling.LANCZOS)
                
                # –£–ª—É—á—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
                enhancer = ImageEnhance.Contrast(column)
                column = enhancer.enhance(1.2)
                enhancer = ImageEnhance.Sharpness(column)
                column = enhancer.enhance(1.3)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ PNG –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∫–∞—á–µ—Å—Ç–≤–∞
                col_path = str(Path(image_path).with_stem(
                    Path(image_path).stem + f"_col{i+1}"
                )).replace('.jpg', '.png').replace('.jpeg', '.png')
                
                column.save(col_path, format='PNG', optimize=False)
                column_images.append(col_path)
            
            return column_images
        
        # –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —à–∏—Ä–æ–∫–∞—è - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        return [image_path]
        
    except Exception as e:
        import sys
        print(f"[WARN] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏: {e}", file=sys.stderr)
        return [image_path]


def _preprocess_image_for_ocr(image_path: str) -> str:
    """
    –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é.
    
    –í–ê–ñ–ù–û: –ê–≤—Ç–æ–ø–æ–≤–æ—Ä–æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω - GPT-4o —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤ –ª—é–±–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏.
    –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∞–∫ –∫–Ω–∏–∂–Ω—ã–µ, —Ç–∞–∫ –∏ –∞–ª—å–±–æ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã.
    –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏.
    """
    # –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    # GPT-4o –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–º–Ω—ã–π, —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ –ª—é–±–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    return image_path


def extract_doc_from_image_gpt(image_path: str, preprocess: bool = True, return_columns: bool = False) -> Dict:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ —Ç–∞–±–ª–∏—Ü—ã –≤ GPT –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
    {
      "doc_type": "production" | "writeoff" | "income",
      "items": [ {"name": "...", "qty": float}, ... ],
      "column_images": [ ... ]  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ return_columns=True
    }
    
    Args:
        image_path: –ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
        preprocess: –ü—Ä–∏–º–µ–Ω—è—Ç—å –ª–∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
        return_columns: –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ª–∏ –ø—É—Ç–∏ –∫ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–º –∫–æ–ª–æ–Ω–∫–∞–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é False)
    """
    # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    if preprocess:
        image_path = _preprocess_image_for_ocr(image_path)
    
    # –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —à–∏—Ä–æ–∫–∞—è
    column_images = _split_table_into_columns(image_path)
    
    # –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–æ–∫ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –æ—Ç–¥–µ–ª—å–Ω–æ
    if len(column_images) > 1:
        import sys
        print(f"[INFO] –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(column_images)} –∫–æ–ª–æ–Ω–æ–∫, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏", file=sys.stderr)
        result = _process_multiple_columns(column_images)
        if return_columns:
            result["column_images"] = column_images
        return result
    
    # –û–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ - –æ–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    b64 = encode_image(image_path)

    prompt = """
–¢—ã ‚Äî —Å–∏—Å—Ç–µ–º–∞ OCR –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∫–∞—Ñ–µ. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–ê —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–≠–¢–ê–ü 1: –û–ü–†–ï–î–ï–õ–ò –¢–ò–ü –î–û–ö–£–ú–ï–ù–¢–ê
–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –ó–ê–ì–û–õ–û–í–û–ö —Ç–∞–±–ª–∏—Ü—ã:
‚Üí "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" = "production"
‚Üí "–°–ø–∏—Å–∞–Ω–∏–µ" = "writeoff"  
‚Üí "–ü—Ä–∏—Ö–æ–¥" = "income"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–≠–¢–ê–ü 2: –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ ‚Äî –†–ê–ë–û–¢–ê–ô –ö–ê–ö –°–ö–ê–ù–ï–†!

üî¥ –ö–†–ò–¢–ò–ß–ù–û: –ü–†–û–ß–ò–¢–ê–ô –í–°–ï –°–¢–†–û–ö–ò –¢–ê–ë–õ–ò–¶–´ –ë–ï–ó –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø!

üî¥ –ê–õ–ì–û–†–ò–¢–ú (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π):

1. –ü–û–°–ß–ò–¢–ê–ô —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)
2. –ù–∞—á–Ω–∏ —Å –ü–ï–†–í–û–ô —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫–æ–ª–æ–Ω–æ–∫)
3. –î–ª—è –ö–ê–ñ–î–û–ô —Å—Ç—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–∏:
   
    –®–∞–≥ 3.1: –ü—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç –≤ –ü–ï–†–í–û–ô (–ª–µ–≤–æ–π) –∫–æ–ª–æ–Ω–∫–µ ‚Üí —ç—Ç–æ –ù–ê–ó–í–ê–ù–ò–ï
    –®–∞–≥ 3.2: –ù–∞ –≠–¢–£ –ñ–ï –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û–ô –õ–ò–ù–ò–ò (–≤–∞–∂–Ω–æ!) –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å ‚Üí —ç—Ç–æ –ö–û–õ–ò–ß–ï–°–¢–í–û
   
    ‚ö†Ô∏è –ü–†–û–í–ï–†–¨ –í–´–†–ê–í–ù–ò–í–ê–ù–ò–ï:
        ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –æ–¥–Ω–æ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã)
        ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –°–ü–†–ê–í–ê –æ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è (–Ω–∞ —Ç–æ–π –∂–µ –≤—ã—Å–æ—Ç–µ)
        ‚Ä¢ –ù–ï –î–û–ü–£–°–ö–ê–ô –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –Ω–∏–∂–µ –∏–ª–∏ –≤—ã—à–µ!
        ‚Ä¢ –ï—Å–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∏—Å–µ–ª ‚Äî –±–µ—Ä–∏ –ü–û–°–õ–ï–î–ù–ï–ï (—Å–∞–º–æ–µ –ø—Ä–∞–≤–æ–µ)
   
    –®–∞–≥ 3.3: –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º:
                ‚úì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî —ç—Ç–æ –ß–ò–°–õ–û (–Ω–µ –ø—Ä–æ—á–µ—Ä–∫, –Ω–µ –ø—É—Å—Ç–æ, –Ω–µ —Ç–µ–∫—Å—Ç)?
                ‚úì –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ?
                ‚úì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –û–î–ù–û–ô –°–¢–†–û–ö–ï —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º (–≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã—Ä–∞–≤–Ω–µ–Ω–æ)?
                ‚Üí –î–ê: –¥–æ–±–∞–≤—å {"name": "...", "qty": —á–∏—Å–ª–æ}
                ‚Üí –ù–ï–¢: –ø—Ä–æ–ø—É—Å—Ç–∏ —ç—Ç—É —Å—Ç—Ä–æ–∫—É (–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ!)
   
4. –ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ –°–õ–ï–î–£–Æ–©–ï–ô —Å—Ç—Ä–æ–∫–µ (–Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –≤–Ω–∏–∑)
5. –ü–æ–≤—Ç–æ—Ä–∏ —à–∞–≥–∏ 3.1-3.3
6. –ü—Ä–æ–¥–æ–ª–∂–∞–π –¥–æ –ü–û–°–õ–ï–î–ù–ï–ô —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
7. –ü–†–û–í–ï–†–¨: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–ª–∏–∑–∫–æ –∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å—Ç—Ä–æ–∫ –∏–∑ —à–∞–≥–∞ 1
8. –ï–°–õ–ò –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è (–º–µ–Ω–µ–µ 50% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ) ‚Üí –ø–µ—Ä–µ—á–∏—Ç–∞–π –±–æ–ª–µ–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ!

üî¥ –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
‚ùå –ß–∏—Ç–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)
‚ùå –ë—Ä–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ N, –∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏ M (–†–ê–ó–ù–´–ï –°–¢–†–û–ö–ò = –û–®–ò–ë–ö–ê!)
‚ùå –ü–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞—Ç—å –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏
‚ùå –î–æ–±–∞–≤–ª—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ —Å –ø—É—Å—Ç—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
‚ùå –ë—Ä–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∏–∑—É–∞–ª—å–Ω–æ –Ω–µ –≤—ã—Ä–∞–≤–Ω–µ–Ω–æ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
‚ùå –ü—É—Ç–∞—Ç—å –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ —Å —è—á–µ–π–∫–∞–º–∏ —Å –¥–∞–Ω–Ω—ã–º–∏

üî¥ –¢–ò–ü–ò–ß–ù–´–ï –û–®–ò–ë–ö–ò (–ù–ï –î–ï–õ–ê–ô –¢–ê–ö):

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û #1 - –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫:
    –°—Ç—Ä–æ–∫–∞ 1: "–ê–Ω–∞–Ω–∞—Å" | (–ø—É—Å—Ç–æ)
    –°—Ç—Ä–æ–∫–∞ 2: "–í–∞–Ω–∏–ª–∏–Ω" | 0.26
   
    ‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç: {"name": "–ê–Ω–∞–Ω–∞—Å", "qty": 0.26} ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! qty –∏–∑ –¥—Ä—É–≥–æ–π —Å—Ç—Ä–æ–∫–∏!

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û #1:
    –°—Ç—Ä–æ–∫–∞ 1: "–ê–Ω–∞–Ω–∞—Å" | (–ø—É—Å—Ç–æ) ‚Üí –ü–†–û–ü–£–°–¢–ò (–Ω–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–µ)
    –°—Ç—Ä–æ–∫–∞ 2: "–í–∞–Ω–∏–ª–∏–Ω" | 0.26 ‚Üí {"name": "–í–∞–Ω–∏–ª–∏–Ω", "qty": 0.26} ‚úì

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û #2 - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ:
    –ù–∞ —Ñ–æ—Ç–æ –≤–∏–¥–Ω–æ:
    –°–ª–µ–≤–∞ "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", –∞ —Å–ø—Ä–∞–≤–∞ –Ω–∞ –¥—Ä—É–≥–æ–π –≤—ã—Å–æ—Ç–µ "3.014"
   
    ‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç: {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "qty": 3.014} ‚Üê –ï—Å–ª–∏ –æ–Ω–∏ –ù–ï –Ω–∞ –æ–¥–Ω–æ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏!

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û #2:
    –ü—Ä–æ–≤–µ—Ä—å –≤–∏–∑—É–∞–ª—å–Ω–æ: –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ª–∏ "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å" –∏ "3.014" –Ω–∞ –û–î–ù–û–ô –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û–ô –õ–ò–ù–ò–ò?
    ‚Üí –î–ê ‚Üí {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "qty": 3.014}
    ‚Üí –ù–ï–¢ ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏ (–∏–ª–∏ –≤–æ–∑—å–º–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ)

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û #3 - –û–±—ã—á–Ω—ã–π —Å–ª—É—á–∞–π:
    –°—Ç—Ä–æ–∫–∞ 1: "–¢–µ—Å—Ç–æ"  | 5  ‚Üí {"name": "–¢–µ—Å—Ç–æ", "qty": 5}
    –°—Ç—Ä–æ–∫–∞ 2: "–ü–µ—Å—Ç–æ"  | 3  ‚Üí {"name": "–ü–µ—Å—Ç–æ", "qty": 3}
    –°—Ç—Ä–æ–∫–∞ 3: "–°–æ—É—Å"   | 2  ‚Üí {"name": "–°–æ—É—Å", "qty": 2}

üî¥ –ï–°–õ–ò –í –°–¢–†–û–ö–ï –ù–ï–°–ö–û–õ–¨–ö–û –ß–ò–°–ï–õ:
–ü—Ä–∏–º–µ—Ä: "–ú–∞—Å–ª–æ | 2.5 –∫–≥ | 1.2 | 500 –≥ | 3.7"
‚Üí –ë–µ—Ä–∏ –ü–û–°–õ–ï–î–ù–ï–ï (—Å–∞–º–æ–µ –ø—Ä–∞–≤–æ–µ) —á–∏—Å–ª–æ: 3.7

–ü—Ä–∏–º–µ—Ä 2: "–ë–æ—Ä–∏–ª–æ | 2 | 170" (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∏–µ –¥—Ä–æ–±–∏)
‚Üí –ü–†–û–í–ï–†–¨: —ç—Ç–æ –æ–¥–Ω–æ —á–∏—Å–ª–æ "2,170" –∏–ª–∏ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö "2" –∏ "170"?
‚Üí –ï—Å–ª–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ —ç—Ç–æ –Ω–∞ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ = —ç—Ç–æ "2,170" –∏–ª–∏ "2170"
‚Üí –ï—Å–ª–∏ –≤ —Ä–∞–∑–Ω—ã—Ö —è—á–µ–π–∫–∞—Ö = –±–µ—Ä–∏ —è—á–µ–π–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–ª–æ–Ω–∫–µ –Ω–∞ –≠–¢–û —Å—Ç—Ä–æ–∫–µ

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–≠–¢–ê–ü 3: –°–ê–ú–û–ü–†–û–í–ï–†–ö–ê (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞!)

–ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞ –∑–∞–¥–∞–π —Å–µ–±–µ –≤–æ–ø—Ä–æ—Å—ã:
1. –Ø —á–∏—Ç–∞–ª —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å—Ç—Ä–æ—á–Ω–æ (–Ω–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ)?
2. –ö–∞–∂–¥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ N –∏–¥—ë—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏–∑ —Å—Ç—Ä–æ–∫–∏ N (–û–î–ù–ê –ò –¢–ê –ñ–ï –°–¢–†–û–ö–ê)?
3. –Ø –ø—Ä–æ–≤–µ—Ä–∏–ª –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã?
4. –í—Å–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ ‚Äî —ç—Ç–æ —á–∏—Å–ª–∞ (–Ω–µ —Ç–µ–∫—Å—Ç)?
5. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å—Ç—Ä–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏?
6. –Ø –ù–ï —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ —Å–æ—Å–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏?

–ï—Å–ª–∏ —Ö–æ—Ç—å –Ω–∞ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –æ—Ç–≤–µ—Ç "–ù–ï–¢" ‚Äî –ø–µ—Ä–µ—á–∏—Ç–∞–π —Ç–∞–±–ª–∏—Ü—É –∑–∞–Ω–æ–≤–æ –í–°–Æ –°–ù–ê–ß–ê–õ–ê!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê ‚Äî —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON:

{
  "doc_type": "production",
  "items": [
    {"name": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞", "qty": 5.5},
    {"name": "–î—Ä—É–≥–æ–π —Ç–æ–≤–∞—Ä", "qty": 2}
  ]
}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π trailing commas: {"name": "x", "qty": 1,} ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: {"name": "x", "qty": 1}
‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ JSON
‚ùå –ù–ï –æ–±–æ—Ä–∞—á–∏–≤–∞–π –≤ ```json ... ```
‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON

–ì–¥–µ:
‚Ä¢ name ‚Äî —Å—Ç—Ä–æ–∫–∞, —á–∏—Å—Ç–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –ø–æ –∫—Ä–∞—è–º)
‚Ä¢ qty ‚Äî –ß–ò–°–õ–û (float –∏–ª–∏ int), –ë–ï–ó –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è, –ë–ï–ó –∫–∞–≤—ã—á–µ–∫

–ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è: {"doc_type": "production", "items": []}

–í–ï–†–ù–ò –¢–û–õ–¨–ö–û –í–ê–õ–ò–î–ù–´–ô JSON, –ù–ò–ß–ï–ì–û –ë–û–õ–¨–®–ï!
"""

    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{b64}"
                        },
                    },
                ],
            }
        ],
        max_tokens=2000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
        temperature=0,
    )

    text = response.choices[0].message.content or ""
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç GPT
    _log_ocr_result(image_path, text)
    
    try:
        raw = _parse_json_strict_or_relaxed(text)
    except Exception as e:
        # –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        import sys
        print(f"[ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å JSON –æ—Ç GPT: {e}", file=sys.stderr)
        print(f"[ERROR] GPT –æ—Ç–≤–µ—Ç (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): {text[:500]}", file=sys.stderr)
        raise RuntimeError(
            "GPT –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "‚Ä¢ –ü–µ—Ä–µ—Å–Ω—è—Ç—å —Ñ–æ—Ç–æ —Å –ª—É—á—à–∏–º –æ—Å–≤–µ—â–µ–Ω–∏–µ–º\n"
            "‚Ä¢ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Ü–µ–ª–∏–∫–æ–º –≤ –∫–∞–¥—Ä–µ\n"
            "‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ"
        ) from e

    if not isinstance(raw, dict):
        raise RuntimeError(f"–û–∂–∏–¥–∞–ª—Å—è JSON-–æ–±—ä–µ–∫—Ç, –∞ –ø—Ä–∏—à–ª–æ:\n{text[:500]}")

    doc_type = raw.get("doc_type", "").strip()
    items_raw = raw.get("items", [])

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º doc_type
    if doc_type not in ("production", "writeoff", "income"):
        # –µ—Å–ª–∏ GPT —Ç—É–ø–∞–Ω—É–ª ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º
        doc_type = "production"

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π
    items: List[Dict] = []
    if isinstance(items_raw, list):
        for it in items_raw:
            if not isinstance(it, dict):
                continue
            name = str(it.get("name", "")).strip()
            qty = it.get("qty")
            if not name:
                continue
            try:
                qty_val = float(qty)
            except (TypeError, ValueError):
                continue
            if qty_val == 0:
                continue
            items.append({"name": name, "qty": qty_val})

    # –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    items = _post_process_ocr_items(items)

    return {
        "doc_type": doc_type,
        "items": items,
    }


def _post_process_ocr_items(items: List[Dict]) -> List[Dict]:
    """
    –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ OCR –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü.
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç:
    - –î—É–±–ª–∏–∫–∞—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π (–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–∫–æ–∫ —Å—Ç—Ä–æ–∫)
    - –ù–µ—Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–≤–∑—è—Ç–∞ –Ω–µ —Ç–∞ –∫–æ–ª–æ–Ω–∫–∞)
    - –ù–∞–∑–≤–∞–Ω–∏—è-—á–∏—Å–ª–∞ (–æ—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫)
    - –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–ª–µ–∏–ª–∏—Å—å –∫–æ–ª–æ–Ω–∫–∏)
    """
    import sys
    
    if not items:
        return items
    
    print(f"[DEBUG] –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ OCR: –ø–æ–ª—É—á–µ–Ω–æ {len(items)} –ø–æ–∑–∏—Ü–∏–π", file=sys.stderr)
    
    cleaned_items = []
    seen_names = {}  # name_lower -> (first_qty, count) –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    filtered_count = 0
    
    for idx, item in enumerate(items):
        name = item.get("name", "").strip()
        qty = item.get("qty", 0)
        
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ
        if not name:
            filtered_count += 1
            print(f"[DEBUG] –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: –ø—É—Å—Ç–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–ø–æ–∑–∏—Ü–∏—è {idx+1})", file=sys.stderr)
            continue
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¢–û–õ–¨–ö–û —á–∏—Å–ª–æ–º (–±–µ–∑ –±—É–∫–≤ –≤–æ–æ–±—â–µ)
        if not any(c.isalpha() for c in name):
            try:
                float(name.replace(",", ".").replace(" ", ""))
                # –≠—Ç–æ —á–∏—Å—Ç–æ–µ —á–∏—Å–ª–æ –±–µ–∑ –±—É–∫–≤ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                filtered_count += 1
                print(f"[DEBUG] –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: –Ω–∞–∑–≤–∞–Ω–∏–µ-—á–∏—Å–ª–æ '{name}' (–ø–æ–∑–∏—Ü–∏—è {idx+1})", file=sys.stderr)
                continue
            except ValueError:
                pass  # –°–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ-—á–∏—Å–ª–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ù–µ—Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        if qty > 10000:
            # –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –≤–∑—è—Ç–∞ –Ω–µ —Ç–∞ –∫–æ–ª–æ–Ω–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞
            if qty > 100000:
                filtered_count += 1
                print(f"[DEBUG] –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: –Ω–µ—Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ {qty} –¥–ª—è '{name}' (–ø–æ–∑–∏—Ü–∏—è {idx+1})", file=sys.stderr)
                continue  # –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–≤—Å–µ–º
            # –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ 1000
            old_qty = qty
            qty = qty / 1000
            item["qty"] = qty
            print(f"[DEBUG] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {old_qty} ‚Üí {qty} –¥–ª—è '{name}'", file=sys.stderr)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–ª–µ–∏–ª–∏—Å—å –∫–æ–ª–æ–Ω–∫–∏)
        if len(name) > 150:
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ –≤ –∫–æ–Ω—Ü–µ –∏ –æ—Ç—Ä–µ–∑–∞—Ç—å
            parts = name.split()
            if len(parts) > 1:
                try:
                    # –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ - —á–∏—Å–ª–æ, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                    potential_qty = float(parts[-1].replace(",", "."))
                    name = " ".join(parts[:-1]).strip()
                    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ 0
                    if qty == 0:
                        qty = potential_qty
                        item["qty"] = qty
                except ValueError:
                    pass
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –î—É–±–ª–∏–∫–∞—Ç—ã (–≤–æ–∑–º–æ–∂–Ω–æ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å—Ç—Ä–æ–∫)
        name_lower = name.lower()
        if name_lower in seen_names:
            # –î—É–±–ª–∏–∫–∞—Ç –Ω–∞–π–¥–µ–Ω
            first_qty, dup_count = seen_names[name_lower]
            
            # –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è - –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            if abs(qty - first_qty) > 0.1:
                # –†–∞–∑–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ - —Å—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
                dup_count += 1
                name = f"{name} ({dup_count})"
                seen_names[name_lower] = (first_qty, dup_count)
                print(f"[DEBUG] –î—É–±–ª–∏–∫–∞—Ç —Å —Ä–∞–∑–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º: '{name}' qty={qty} (–ø–µ—Ä–≤—ã–π –±—ã–ª {first_qty})", file=sys.stderr)
            else:
                # –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Ä–µ–∞–ª—å–Ω—ã–π –¥—É–±–ª–∏–∫–∞—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ OCR
                # –û–°–õ–ê–ë–õ–Ø–ï–ú: –æ—Å—Ç–∞–≤–ª—è–µ–º, –Ω–æ –Ω—É–º–µ—Ä—É–µ–º
                dup_count += 1
                name = f"{name} ({dup_count})"
                seen_names[name_lower] = (first_qty, dup_count)
                print(f"[DEBUG] –î—É–±–ª–∏–∫–∞—Ç —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º: '{name}' qty={qty}", file=sys.stderr)
        else:
            seen_names[name_lower] = (qty, 1)
        
        cleaned_items.append({"name": name, "qty": qty})
    
    print(f"[DEBUG] –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞: –æ—Å—Ç–∞–ª–æ—Å—å {len(cleaned_items)} –ø–æ–∑–∏—Ü–∏–π, –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ {filtered_count}", file=sys.stderr)
    return cleaned_items


def correct_items_with_instruction(items: List[Dict], instruction: str) -> List[Dict]:
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ items –∏ —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é (–Ω–∞ —Ä—É—Å—Å–∫–æ–º),
    –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ù–û–í–´–ô —Å–ø–∏—Å–æ–∫ items –ø–æ—Å–ª–µ –ø—Ä–∞–≤–æ–∫.
    """
    items_json = json.dumps(items, ensure_ascii=False)

    prompt = (
        "–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–ø–∏—Å–∫–∞ –±–ª—é–¥ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤ –¥–ª—è –∞–∫—Ç–∞ "
        "–≤—ã–ø—É—Å–∫–∞/—Å–ø–∏—Å–∞–Ω–∏—è/–ø—Ä–∏—Ö–æ–¥–∞.\n\n"
        "–í–æ—Ç —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:\n"
        f"{items_json}\n\n"
        "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
        "- \"–∏–∑–º–µ–Ω–∏ –ø–µ—Å—Ç–æ –Ω–∞ —Ç–µ—Å—Ç–æ\"\n"
        "- \"—Ç–µ—Å—Ç–æ –Ω–µ 2, –∞ 3\"\n"
        "- \"—É–±–µ—Ä–∏ –∫—Ä—É—Ç–æ–Ω—ã, –¥–æ–±–∞–≤—å –ö—Ä—ã–ª—ã—à–∫–∏ 4\"\n"
        "- \"–¥–æ–±–∞–≤—å –¢–µ—Å—Ç–æ 5\"\n\n"
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞:\n"
        "1. –ü–æ–Ω—è—Ç—å, —á—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.\n"
        "2. –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ —Å–ø–∏—Å–∫—É.\n"
        "3. –í–µ—Ä–Ω—É—Ç—å –û–ë–ù–û–í–õ–Å–ù–ù–´–ô —Å–ø–∏—Å–æ–∫ –≤ –¢–û–ß–ù–û –¢–ê–ö–û–ú –ñ–ï JSON-–§–û–†–ú–ê–¢–ï ‚Äî "
        "–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏ name (—Å—Ç—Ä–æ–∫–∞) –∏ qty (—á–∏—Å–ª–æ).\n\n"
        "–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:\n"
        "- –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON-–º–∞—Å—Å–∏–≤, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ —Ç–µ–∫—Å—Ç–∞.\n"
        "- name ‚Äî —Å—Ç—Ä–æ–∫–∞, qty ‚Äî —á–∏—Å–ª–æ (float).\n"
        "- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ —É–¥–∞–ª–∏—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –≤–∫–ª—é—á–∞–π —ç—Ç–æ –≤ –∏—Ç–æ–≥–æ–≤—ã–π –º–∞—Å—Å–∏–≤.\n\n"
        f"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n{instruction}\n"
    )

    client = _get_openai_client()
    response = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {
                "role": "user",
                "content": prompt,
            }
        ],
        max_tokens=500,
        temperature=0,
    )

    text = response.choices[0].message.content or ""
    raw_items = _parse_json_strict_or_relaxed(text)

    if not isinstance(raw_items, list):
        raise RuntimeError(f"–û–∂–∏–¥–∞–ª—Å—è JSON-–º–∞—Å—Å–∏–≤ –ø–æ—Å–ª–µ –ø—Ä–∞–≤–∫–∏, –∞ –ø—Ä–∏—à–ª–æ:\n{text}")

    norm_items: List[Dict] = []
    for it in raw_items:
        if not isinstance(it, dict):
            continue
        name = str(it.get("name", "")).strip()
        qty = it.get("qty")
        if not name:
            continue
        try:
            qty_val = float(qty)
        except (TypeError, ValueError):
            continue
        norm_items.append({"name": name, "qty": qty_val})

    return norm_items
