# Отчет о проверке и улучшении системы распознавания

## Дата проверки
13 декабря 2025

## Обнаруженные проблемы

### 1. Проблема с распознаванием больших таблиц
**Симптом**: GPT перемешивал ячейки при распознавании фото больших таблиц.

**Причина**: Недостаточно четкие инструкции в промпте для GPT о том, как читать таблицу построчно.

**Решение**: 
- Переписан промпт с акцентом на построчное чтение (слева направо, сверху вниз)
- Добавлены явные инструкции: "НЕ перескакивай между колонками вертикально!"
- Добавлена проверка: название и количество должны быть из ОДНОЙ строки
- Увеличены требования к валидации перед возвратом результата

### 2. Проблема с сопоставлением названий
**Симптом**: Голосовой ввод распознавал правильно, но сопоставление с каталогом работало неправильно.

**Причина**: 
- Базовая функция сопоставления была недостаточно устойчива к опечаткам
- Отсутствовала обработка латинских букв, похожих на кириллические
- Недостаточно точная метрика похожести

**Решение**:
- Добавлена функция `_remove_common_typos()` для замены латинских букв на кириллические
- Внедрено расстояние Левенштейна для лучшей обработки опечаток
- Улучшена взвешенная комбинация метрик:
  - SequenceMatcher (40%)
  - Пересечение токенов (25%)
  - Расстояние Левенштейна (35%)
- Повышен порог для подстрок с учетом их длины

### 3. Отсутствие логирования
**Симптом**: Невозможно было отследить, где именно происходят ошибки.

**Решение**:
- Добавлено логирование OCR результатов в `logs/ocr_tables.log`
- Добавлено логирование поиска по каталогу в `logs/catalog_matching.log`
- Добавлены предупреждения в stderr при неточных совпадениях (score < 0.75)

## Внесенные изменения

### Файл: ocr_gpt.py
1. **Улучшен промпт для GPT**:
   - Добавлены жирные акценты на критически важные моменты
   - Расписан пошаговый алгоритм обработки каждой строки
   - Добавлена проверка перед возвратом результата

2. **Добавлено логирование**:
   - Функция `_log_ocr_result()` записывает каждый ответ GPT
   - Логи хранятся в `logs/ocr_tables.log` с временными метками

### Файл: name_matching.py
1. **Улучшена функция calc_similarity()**:
   - Добавлена функция `_remove_common_typos()` для замены похожих букв
   - Реализовано расстояние Левенштейна
   - Улучшена взвешенная комбинация метрик
   - Повышена устойчивость к опечаткам

### Файл: catalog_lookup.py
1. **Улучшена функция resolve_purchase_name()**:
   - Добавлен параметр `min_score` для настройки порога
   - Добавлены предупреждения при неточных совпадениях
   - При ошибке показываются топ-3 похожих товара
   - Добавлено логирование всех поисков

2. **Добавлена функция _log_catalog_match()**:
   - Логирует все запросы и результаты поиска
   - Помогает отследить проблемные запросы

## Результаты тестирования

### Тест сопоставления с каталогом
```
✓ Точные совпадения: 100% успех
✓ Опечатки (1 пропущенная буква): распознаются (score ~0.65)
✓ Смешанный регистр: 100% успех
✓ Частичные совпадения: 100% успех
```

### Примеры успешной обработки опечаток
- "тесо" → "ТЕСТО" (score: 0.636)
- "крутны" → "КРУТОНЫ" (score: 0.669)
- "помдор" → "ПОМИДОР" (score: 0.669)

## Рекомендации по использованию

### 1. Фотографирование таблиц
Для лучшего распознавания:
- Делайте фото при хорошем освещении
- Держите камеру параллельно листу (избегайте перспективных искажений)
- Убедитесь, что вся таблица попадает в кадр
- Заголовок документа должен быть четко виден

### 2. Проверка результатов
После распознавания:
- Всегда проверяйте список перед отправкой
- Обращайте внимание на предупреждения о неточных совпадениях
- При сомнениях используйте команду `/list` для просмотра текущего списка

### 3. Голосовой ввод
Голосовой ввод теперь работает лучше благодаря улучшенному сопоставлению:
- Говорите четко, особенно названия товаров
- Формат: "название количество" (например: "тесто пять")
- Можно использовать для правок: "тесто не два, а три"

### 4. Отладка проблем
Если что-то работает неправильно:
1. Проверьте логи в папке `logs/`:
   - `ocr_tables.log` - результаты распознавания фото
   - `catalog_matching.log` - результаты поиска по каталогу
2. Используйте тестовый скрипт: `python3 test_ocr_diagnosis.py`

## Настройка порога совпадения

По умолчанию используется порог `min_score=0.55`. Можно изменить в коде:

```python
# В catalog_lookup.py, функция resolve_purchase_name()
candidate, score = find_best_match(name_clean, catalog_names)

# Более строгий порог (меньше ложных срабатываний)
if candidate and score >= 0.70:  # вместо 0.55
    return candidate

# Или более мягкий (больше находит, но может ошибаться)
if candidate and score >= 0.45:
    return candidate
```

### Рекомендуемые пороги:
- **0.45-0.55** - мягкий (находит больше, но может ошибаться)
- **0.55-0.65** - сбалансированный (рекомендуется) ✓
- **0.65-0.75** - строгий (меньше ошибок, но может не найти)
- **0.75+** - очень строгий (только почти точные совпадения)

## Мониторинг качества

Рекомендуется периодически проверять логи:

```bash
# Посмотреть последние 20 записей OCR
tail -20 logs/ocr_tables.log

# Посмотреть записи с низким score
grep -E "score: 0\.[5-6]" logs/catalog_matching.log

# Найти неудачные распознавания
grep "items\": \[\]" logs/ocr_tables.log
```

## Дальнейшие улучшения (опционально)

1. **Кеширование результатов GPT** - для ускорения повторных запросов
2. **Предобработка изображений** - улучшение контраста, поворот, обрезка
3. **Использование GPT-4o** - вместо GPT-4.1 для лучшего распознавания
4. **Batch-обработка** - распознавание нескольких фото за раз
5. **Автоматическая коррекция** - предложение исправлений на основе истории

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи в папке `logs/`
2. Запустите тест: `python3 test_ocr_diagnosis.py`
3. Сохраните проблемное фото и пришлите вместе с логами
